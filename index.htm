<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Order Picker</title>
  <style>
    :root { --primary: #007aff; --bg: #f9f9f9; --card: #fff; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin:0; }
    .container { padding: 1rem; }
    h1 { text-align:center; color: #333; }
    .card { background: var(--card); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
    input, button { font-size: 1rem; padding: .6rem; border-radius: 8px; border: 1px solid #ddd; margin: .3rem 0; width: 100%; }
    button { background: var(--primary); color: white; border: none; font-weight: 600; }
    .btn-small { padding: .4rem .8rem; font-size: .9rem; width: auto; display: inline-block; }
    .row { display: flex; gap: .5rem; align-items: center; }
    .qty { width: 4rem; text-align: center; }
    .scanner { height: 200px; background: #000; overflow: hidden; border-radius: 8px; margin: 1rem 0; }
    #barcode-canvas { width: 100%; height: 100%; object-fit: cover; }
    .list-item { display: flex; justify-content: space-between; padding: .5rem 0; border-bottom: 1px solid #eee; }
    .barcode-svg { height: 50px; margin: .5rem 0; }
    .hidden { display: none; }
    .footer { text-align: center; margin: 2rem 0 1rem; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Order Picker</h1>

    <div class="card">
      <button id="start-scan">Start Camera Scan</button>
      <div id="scanner-container" class="scanner hidden"><div id="barcode-canvas"></div></div>
      <button id="stop-scan" class="hidden">Stop Scanning</button>
    </div>

    <div class="card">
      <label>Product Code</label>
      <input type="text" id="code" placeholder="Enter or scan code" autofocus />
      <label>Quantity</label>
      <div class="row">
        <button class="btn-small" id="dec-qty">-</button>
        <input type="number" id="qty" class="qty" value="1" min="1" />
        <button class="btn-small" id="inc-qty">+</button>
      </div>
      <button id="add-item">Add to List</button>
    </div>

    <div class="card">
      <h2>Current List (<span id="item-count">0</span>)</h2>
      <div id="list"></div>
    </div>

    <div class="card hidden" id="summary-card">
      <h2>Ready to Scan at POS</h2>
      <div id="summary"></div>
      <button id="copy-text">Copy List as Text</button>
    </div>

    <div class="footer">
      <button id="finish">Finish & Show Barcodes</button>
      <button id="clear-all" style="background:#ff3b30;">Clear All</button>
    </div>
  </div>

<script>
  const STORAGE_KEY = 'storePickerList';
  let list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  const els = {
    code: document.getElementById('code'), qty: document.getElementById('qty'),
    addBtn: document.getElementById('add-item'), listEl: document.getElementById('list'),
    countEl: document.getElementById('item-count'), startBtn: document.getElementById('start-scan'),
    stopBtn: document.getElementById('stop-scan'), scannerBox: document.getElementById('scanner-container'),
    canvas: document.getElementById('barcode-canvas'), decQty: document.getElementById('dec-qty'),
    incQty: document.getElementById('inc-qty'), finishBtn: document.getElementById('finish'),
    summaryCard: document.getElementById('summary-card'), summaryEl: document.getElementById('summary'),
    clearBtn: document.getElementById('clear-all'), copyBtn: document.getElementById('copy-text')
  };

  els.decQty.onclick = () => { if (els.qty.value > 1) els.qty.value--; };
  els.incQty.onclick = () => els.qty.value++;

  function render() {
    els.listEl.innerHTML = ''; els.countEl.textContent = list.length;
    list.forEach((item, i) => {
      const div = document.createElement('div'); div.className = 'list-item';
      div.innerHTML = `<div><strong>${item.code}</strong> × ${item.qty}</div>
        <div><button class="btn-small" style="background:#ff9500;" onclick="editItem(${i})">Edit</button>
        <button class="btn-small" style="background:#ff3b30;" onclick="removeItem(${i})">×</button></div>`;
      els.listEl.appendChild(div);
    });
    save();
  }
  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

  function addItem() {
    const code = els.code.value.trim();
    if (!code) return alert('Enter code');
    const qty = parseInt(els.qty.value) || 1;
    const existing = list.findIndex(it => it.code === code);
    if (existing > -1) list[existing].qty += qty; else list.push({ code, qty });
    els.code.value = ''; els.qty.value = 1; els.code.focus(); render();
  }
  els.addBtn.onclick = addItem;
  els.code.addEventListener('keypress', e => { if (e.key === 'Enter') addItem(); });

  window.editItem = i => { const it = list[i]; els.code.value = it.code; els.qty.value = it.qty; list.splice(i,1); render(); els.code.focus(); };
  window.removeItem = i => { if (confirm('Remove?')) { list.splice(i,1); render(); } };

  let scannerActive = false;
  els.startBtn.onclick = () => {
    if (scannerActive) return;
    els.scannerBox.classList.remove('hidden'); els.stopBtn.classList.remove('hidden'); els.startBtn.classList.add('hidden');
    scannerActive = true;
    Quagga.init({
      inputStream: { name: "Live", type: "LiveStream", target: els.canvas,
        constraints: { facingMode: "environment", width: 640, height: 480 } },
      locator: { patchSize: "medium", halfSample: true },
      numOfWorkers: 2, frequency: 10,
      decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader"] },
      locate: true
    }, err => { if (err) { alert('Camera error'); stopScanner(); return; } Quagga.start(); });
    Quagga.onDetected(d => { els.code.value = d.codeResult.code; stopScanner(); addItem(); });
  };
  function stopScanner() {
    if (!scannerActive) return;
    Quagga.stop(); els.scannerBox.classList.add('hidden'); els.stopBtn.classList.add('hidden'); els.startBtn.classList.remove('hidden');
    scannerActive = false;
  }
  els.stopBtn.onclick = stopScanner;

  els.finishBtn.onclick = () => {
    if (!list.length) return alert('Empty');
    els.summaryCard.classList.remove('hidden'); els.summaryEl.innerHTML = '';
    let text = '';
    list.forEach(item => {
      const div = document.createElement('div'); div.style = 'margin:1rem 0;text-align:center;';
      div.innerHTML = `<div style="font-weight:600;">${item.code} × ${item.qty}</div><svg class="barcode-svg" data-code="${item.code}"></svg>`;
      els.summaryEl.appendChild(div);
      text += `${item.code} × ${item.qty}\n`;
      setTimeout(() => JsBarcode(`svg[data-code="${item.code}"]`, item.code, {format:"CODE128",width:2,height:50,displayValue:true}), 50);
    });
    els.copyBtn.onclick = () => navigator.clipboard.writeText(text).then(() => alert('Copied!')).catch(() => prompt('Copy:', text));
    els.summaryCard.scrollIntoView({behavior:'smooth'});
  };

  els.clearBtn.onclick = () => {
    if (confirm('Clear all?')) { list = []; localStorage.removeItem(STORAGE_KEY); render(); els.summaryCard.classList.add('hidden'); }
  };

  render();
</script>
</body>
</html>