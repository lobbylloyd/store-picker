<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Order Picker App">
  <meta name="theme-color" content="#4facfe">
  <title>Order Picker App</title>

  <!-- PWA ICONS - Using your uploaded image -->
  <link rel="apple-touch-icon" sizes="180x180" href="IMG_6879.png">
  <link rel="apple-touch-icon" sizes="192x192" href="IMG_6879.png">
  <link rel="apple-touch-icon" sizes="512x512" href="IMG_6879.png">
  <link rel="icon" type="image/png" sizes="512x512" href="IMG_6879.png">

  <style>
    /* Light Blue-Green Gradient */
    body {
      margin: 0;
      font-family: -apple-system, sans-serif;
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 50%, #d4fc79 100%);
      min-height: 100vh;
      color: #1a1a1a;
    }

    .container {
      padding: 1.2rem;
      max-width: 100%;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    h1 {
      text-align: center;
      font-size: 1.9rem;
      margin: 0.5rem 0 1.2rem;
      font-weight: 700;
      color: #1a1a1a;
    }

    h2 {
      font-size: 1.4rem;
      margin: 0 0 1rem;
      color: #1a1a1a;
      font-weight: 700;
      text-align: center;
    }

    label {
      display: block;
      font-weight: 700;
      font-size: 1.3rem;
      margin: 1.2rem 0 0.6rem;
      color: #1a1a1a;
      text-align: center;
    }

    input, button {
      font-size: 1.1rem;
      padding: 0.8rem;
      border-radius: 12px;
      border: none;
      margin: 0.4rem 0;
      width: 100%;
      box-sizing: border-box;
    }

    input {
      background: rgba(255, 255, 255, 0.95);
      color: #1a1a1a;
      text-align: center;
      font-weight: 500;
    }

    input::placeholder {
      color: #666;
    }

    button {
      background: #4facfe;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-small {
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      width: auto;
      display: inline-block;
    }

    .row {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      justify-content: center;
    }

    .qty {
      width: 5.5rem;
      text-align: center;
      font-size: 1.1rem;
    }

    .scanner {
      height: 240px;
      background: #000;
      overflow: hidden;
      border-radius: 14px;
      margin: 1.2rem 0;
    }

    #barcode-canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 1.2rem;
      font-weight: 500;
    }

    .hidden { display: none; }

    .footer {
      text-align: center;
      margin: 2.5rem 0 1.5rem;
    }

    /* Centered Input */
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .input-group input {
      max-width: 90%;
    }

    /* Summary: Code Left, Qty Right, Full-Width Barcode */
    .summary-item {
      margin: 3rem 0;
      padding: 0 1rem;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
      font-weight: 800;
      font-size: 1.7rem;
      color: #1a1a1a;
    }

    .barcode-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 1.2rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .barcode-svg {
      width: 100% !important;
      height: auto !important;
      display: block;
      margin: 0 auto;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Order Picker App</h1>

    <!-- SCANNER -->
    <div class="glass-card">
      <button id="start-scan">Start Camera Scan</button>
      <div id="scanner-container" class="scanner hidden"><div id="barcode-canvas"></div></div>
      <button id="stop-scan" class="hidden">Stop Scanning</button>
    </div>

    <!-- MANUAL ENTRY -->
    <div class="glass-card">
      <div class="input-group">
        <label>Product Code</label>
        <input type="text" id="code" placeholder="Enter or scan code" autofocus />
      </div>
      <div class="input-group">
        <label>Quantity</label>
        <div class="row">
          <button class="btn-small" id="dec-qty">-</button>
          <input type="number" id="qty" class="qty" value="1" min="1" />
          <button class="btn-small" id="inc-qty">+</button>
        </div>
      </div>
      <button id="add-item">Add to List</button>
    </div>

    <!-- PICKING LIST -->
    <div class="glass-card">
      <h2>Picking List (<span id="item-count">0</span>)</h2>
      <div id="list"></div>
    </div>

    <!-- FINAL SUMMARY -->
    <div class="glass-card hidden" id="summary-card">
      <h2>Ready to Scan at POS</h2>
      <div id="summary"></div>
      <button id="copy-text">Copy List as Text</button>
    </div>

    <div class="footer">
      <button id="finish">Finish & Show Barcodes</button>
      <button id="clear-all" style="background:#ff3b30;">Clear All</button>
    </div>
  </div>

<script>
  const STORAGE_KEY = 'orderPickerList';
  let list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  const els = {
    code: document.getElementById('code'), qty: document.getElementById('qty'),
    addBtn: document.getElementById('add-item'), listEl: document.getElementById('list'),
    countEl: document.getElementById('item-count'), startBtn: document.getElementById('start-scan'),
    stopBtn: document.getElementById('stop-scan'), scannerBox: document.getElementById('scanner-container'),
    canvas: document.getElementById('barcode-canvas'), decQty: document.getElementById('dec-qty'),
    incQty: document.getElementById('inc-qty'), finishBtn: document.getElementById('finish'),
    summaryCard: document.getElementById('summary-card'), summaryEl: document.getElementById('summary'),
    clearBtn: document.getElementById('clear-all'), copyBtn: document.getElementById('copy-text')
  };

  els.decQty.onclick = () => { if (els.qty.value > 1) els.qty.value--; };
  els.incQty.onclick = () => els.qty.value++;

  function render() {
    els.listEl.innerHTML = ''; els.countEl.textContent = list.length;
    list.forEach((item, i) => {
      const div = document.createElement('div'); div.className = 'list-item';
      div.innerHTML = `<div><strong>${item.code}</strong> × ${item.qty}</div>
        <div><button class="btn-small" style="background:#ff9500;" onclick="editItem(${i})">Edit</button>
        <button class="btn-small" style="background:#ff3b30;" onclick="removeItem(${i})">×</button></div>`;
      els.listEl.appendChild(div);
    });
    save();
  }
  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

  function addItem() {
    const code = els.code.value.trim();
    if (!code) return alert('Enter code');
    const qty = parseInt(els.qty.value) || 1;
    const existing = list.findIndex(it => it.code === code);
    if (existing > -1) list[existing].qty += qty; else list.push({ code, qty });
    els.code.value = ''; els.qty.value = 1; els.code.focus(); render();
  }
  els.addBtn.onclick = addItem;
  els.code.addEventListener('keypress', e => { if (e.key === 'Enter') addItem(); });

  window.editItem = i => { const it = list[i]; els.code.value = it.code; els.qty.value = it.qty; list.splice(i,1); render(); els.code.focus(); };
  window.removeItem = i => { if (confirm('Remove?')) { list.splice(i,1); render(); } };

  let scannerActive = false;
  els.startBtn.onclick = () => {
    if (scannerActive) return;
    els.scannerBox.classList.remove('hidden'); els.stopBtn.classList.remove('hidden'); els.startBtn.classList.add('hidden');
    scannerActive = true;
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: els.canvas,
        constraints: { facingMode: "environment", width: 640, height: 480 }
      },
      locator: { patchSize: "large", halfSample: true },
      numOfWorkers: 2,
      frequency: 10,
      decoder: { readers: ["ean_reader"] },  // Only EAN for reliable full codes
      locate: true
    }, err => {
      if (err) { alert('Camera error: ' + err); stopScanner(); return; }
      Quagga.start();
    });
    Quagga.onDetected(data => {
      const code = data.codeResult.code;
      if (code && code.length >= 12) {
        els.code.value = code;  // Only fill input, do NOT auto-add
        stopScanner();
        els.code.focus();  // Ready for quantity
      }
    });
  };

  function stopScanner() {
    if (!scannerActive) return;
    Quagga.stop();
    els.scannerBox.classList.add('hidden');
    els.stopBtn.classList.add('hidden');
    els.startBtn.classList.remove('hidden');
    scannerActive = false;
  }
  els.stopBtn.onclick = stopScanner;

  els.finishBtn.onclick = () => {
    if (!list.length) return alert('Empty');
    els.summaryCard.classList.remove('hidden'); els.summaryEl.innerHTML = '';
    let text = '';
    list.forEach(item => {
      const div = document.createElement('div');
      div.style = 'margin:2.5rem 0; text-align:center;';
      div.innerHTML = `
        <div style="font-weight:800; font-size:1.7rem; margin-bottom:1rem; display:flex; justify-content:space-between; padding:0 1rem;">
          <span>${item.code}</span><span>${item.qty}</span>
        </div>
        <svg class="barcode-svg" data-code="${item.code}"></svg>
      `;
      els.summaryEl.appendChild(div);
      text += `${item.code} × ${item.qty}\n`;
      setTimeout(() => {
        JsBarcode(`svg[data-code="${item.code}"]`, item.code, {
          format: "CODE128",
          lineColor: "#000",
          width: 4,
          height: 120,
          displayValue: true,
          fontSize: 32
        });
      }, 100);
    });
    els.copyBtn.onclick = () => navigator.clipboard.writeText(text).then(() => alert('Copied!')).catch(() => prompt('Copy:', text));
    els.summaryCard.scrollIntoView({behavior:'smooth'});
  };

  els.clearBtn.onclick = () => {
    if (confirm('Clear all?')) { list = []; localStorage.removeItem(STORAGE_KEY); render(); els.summaryCard.classList.add('hidden'); }
  };

  render();
</script>
</body>
</html>